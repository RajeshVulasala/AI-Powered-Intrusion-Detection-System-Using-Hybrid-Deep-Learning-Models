export async function POST(request) {
  try {
    const { name, url } = await request.json();

    if (!name || !url) {
      return Response.json(
        { error: "Dataset name and URL required" },
        { status: 400 },
      );
    }

    // Standard dataset URLs (in production, these would be real URLs)
    const standardDatasets = {
      "NSL-KDD": {
        url: "https://www.unb.ca/cic/datasets/nsl.html",
        localPath: "/datasets/nsl-kdd.csv",
        description: "NSL-KDD dataset for network intrusion detection",
      },
      CICIDS2017: {
        url: "https://www.unb.ca/cic/datasets/ids-2017.html",
        localPath: "/datasets/cicids2017.csv",
        description: "CICIDS2017 dataset for intrusion detection",
      },
      "UNSW-NB15": {
        url: "https://research.unsw.edu.au/projects/unsw-nb15-dataset",
        localPath: "/datasets/unsw-nb15.csv",
        description: "UNSW-NB15 network intrusion dataset",
      },
      "BoT-IoT": {
        url: "https://www.unsw.adfa.edu.au/unsw-canberra-cyber/cybersecurity/ADFA-NB15-Datasets/",
        localPath: "/datasets/bot-iot.csv",
        description: "BoT-IoT dataset for IoT network security",
      },
    };

    const dataset = standardDatasets[name];
    if (!dataset) {
      return Response.json({ error: "Unknown dataset" }, { status: 404 });
    }

    // In production, you would actually download the file here
    // For demo purposes, we'll simulate the download and return metadata

    const downloadResult = {
      id: Date.now().toString(),
      name: name,
      localPath: dataset.localPath,
      originalUrl: dataset.url,
      description: dataset.description,
      downloadedAt: new Date().toISOString(),
      status: "downloaded",
      url: dataset.localPath,
      fileSize: getEstimatedFileSize(name),
      preview: generateStandardDatasetPreview(name),
    };

    // Simulate download time
    await new Promise((resolve) => setTimeout(resolve, 1000));

    return Response.json({
      success: true,
      dataset: downloadResult,
      url: downloadResult.url,
    });
  } catch (error) {
    console.error("Download error:", error);
    return Response.json({ error: "Download failed" }, { status: 500 });
  }
}

function getEstimatedFileSize(datasetName) {
  const sizes = {
    "NSL-KDD": "125 MB",
    CICIDS2017: "2.1 GB",
    "UNSW-NB15": "847 MB",
    "BoT-IoT": "1.2 GB",
  };
  return sizes[datasetName] || "Unknown";
}

function generateStandardDatasetPreview(datasetName) {
  const previews = {
    "NSL-KDD": {
      type: "csv",
      headers: [
        "duration",
        "protocol_type",
        "service",
        "flag",
        "src_bytes",
        "dst_bytes",
        "land",
        "wrong_fragment",
        "urgent",
        "hot",
        "num_failed_logins",
        "logged_in",
        "num_compromised",
        "root_shell",
        "su_attempted",
        "num_root",
        "num_file_creations",
        "num_shells",
        "num_access_files",
        "num_outbound_cmds",
        "is_host_login",
        "is_guest_login",
        "count",
        "srv_count",
        "serror_rate",
        "srv_serror_rate",
        "rerror_rate",
        "srv_rerror_rate",
        "same_srv_rate",
        "diff_srv_rate",
        "srv_diff_host_rate",
        "dst_host_count",
        "dst_host_srv_count",
        "dst_host_same_srv_rate",
        "dst_host_diff_srv_rate",
        "dst_host_same_src_port_rate",
        "dst_host_srv_diff_host_rate",
        "dst_host_serror_rate",
        "dst_host_srv_serror_rate",
        "dst_host_rerror_rate",
        "dst_host_srv_rerror_rate",
        "attack_type",
      ],
      rows: [
        [
          "0",
          "tcp",
          "http",
          "SF",
          "232",
          "8153",
          "0",
          "0",
          "0",
          "0",
          "0",
          "1",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "8",
          "8",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "1.0",
          "0.0",
          "0.0",
          "9",
          "9",
          "1.0",
          "0.0",
          "0.11",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "normal",
        ],
        [
          "0",
          "tcp",
          "http",
          "SF",
          "239",
          "486",
          "0",
          "0",
          "0",
          "0",
          "0",
          "1",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "8",
          "8",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "1.0",
          "0.0",
          "0.0",
          "19",
          "19",
          "1.0",
          "0.0",
          "0.05",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "normal",
        ],
        [
          "0",
          "tcp",
          "http",
          "SF",
          "238",
          "1282",
          "0",
          "0",
          "0",
          "0",
          "0",
          "1",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "8",
          "8",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "1.0",
          "0.0",
          "0.0",
          "29",
          "29",
          "1.0",
          "0.0",
          "0.03",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "0.0",
          "normal",
        ],
      ],
      totalRows: 148517,
      totalColumns: 42,
    },

    CICIDS2017: {
      type: "csv",
      headers: [
        "Destination Port",
        "Flow Duration",
        "Total Fwd Packets",
        "Total Backward Packets",
        "Total Length of Fwd Packets",
        "Total Length of Bwd Packets",
        "Fwd Packet Length Max",
        "Fwd Packet Length Min",
        "Fwd Packet Length Mean",
        "Bwd Packet Length Max",
        "Flow Bytes/s",
        "Flow Packets/s",
        "Flow IAT Mean",
        "Flow IAT Std",
        "Fwd IAT Total",
        "Active Mean",
        "Active Std",
        "Idle Mean",
        "Idle Std",
        "Label",
      ],
      rows: [
        [
          "80",
          "120000000",
          "20",
          "18",
          "1284",
          "1210",
          "89",
          "0",
          "64.2",
          "78",
          "20.7",
          "0.317",
          "6315789",
          "7936843",
          "119802133",
          "0",
          "0",
          "0",
          "0",
          "BENIGN",
        ],
        [
          "80",
          "17000",
          "5",
          "6",
          "362",
          "424",
          "89",
          "54",
          "72.4",
          "78",
          "46235.3",
          "0.647",
          "3400",
          "1697",
          "16580",
          "0",
          "0",
          "0",
          "0",
          "BENIGN",
        ],
        [
          "22",
          "181000000",
          "41",
          "39",
          "2426",
          "2297",
          "89",
          "0",
          "59.2",
          "78",
          "26.1",
          "0.442",
          "4414634",
          "9433779",
          "180654719",
          "0",
          "0",
          "0",
          "0",
          "BENIGN",
        ],
      ],
      totalRows: 2830743,
      totalColumns: 78,
    },

    "UNSW-NB15": {
      type: "csv",
      headers: [
        "srcip",
        "sport",
        "dstip",
        "dsport",
        "proto",
        "state",
        "dur",
        "sbytes",
        "dbytes",
        "sttl",
        "dttl",
        "sloss",
        "dloss",
        "service",
        "sload",
        "dload",
        "spkts",
        "dpkts",
        "swin",
        "dwin",
        "stcpb",
        "dtcpb",
        "smeansz",
        "dmeansz",
        "trans_depth",
        "res_bdy_len",
        "sjit",
        "djit",
        "stime",
        "ltime",
        "sintpkt",
        "dintpkt",
        "tcprtt",
        "synack",
        "ackdat",
        "is_sm_ips_ports",
        "ct_state_ttl",
        "ct_flw_http_mthd",
        "is_ftp_login",
        "ct_ftp_cmd",
        "ct_srv_src",
        "ct_srv_dst",
        "ct_dst_ltm",
        "ct_src_ltm",
        "ct_src_dport_ltm",
        "ct_dst_sport_ltm",
        "ct_dst_src_ltm",
        "attack_cat",
        "label",
      ],
      rows: [
        [
          "149.171.126.6",
          "80",
          "59.166.0.6",
          "39681",
          "tcp",
          "FIN",
          "3.05",
          "1032",
          "2048",
          "254",
          "63",
          "0",
          "1",
          "http",
          "337.93",
          "670.89",
          "4",
          "4",
          "8192",
          "65535",
          "0",
          "2147875072",
          "258",
          "512",
          "1",
          "0",
          "0.00",
          "0.00",
          "1.393237e+09",
          "1.393237e+09",
          "1.016667",
          "1.016667",
          "0.00",
          "0.00",
          "0.00",
          "0",
          "2",
          "0",
          "0",
          "0",
          "1",
          "1",
          "25",
          "1",
          "1",
          "1",
          "Normal",
          "0",
        ],
        [
          "149.171.126.6",
          "80",
          "59.166.0.1",
          "56000",
          "tcp",
          "CON",
          "0.00",
          "0",
          "0",
          "254",
          "0",
          "0",
          "0",
          "http",
          "0.00",
          "0.00",
          "1",
          "0",
          "8192",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0",
          "0.00",
          "0.00",
          "1.393237e+09",
          "1.393237e+09",
          "0.000000",
          "0.000000",
          "0.00",
          "0.00",
          "0.00",
          "0",
          "1",
          "0",
          "0",
          "0",
          "13",
          "1",
          "1",
          "1",
          "1",
          "1",
          "Normal",
          "0",
        ],
      ],
      totalRows: 2540044,
      totalColumns: 49,
    },

    "BoT-IoT": {
      type: "csv",
      headers: [
        "pkSeqID",
        "stime",
        "flgs",
        "flgs_number",
        "proto",
        "saddr",
        "sport",
        "daddr",
        "dport",
        "pkts",
        "bytes",
        "state",
        "ltime",
        "seq",
        "dur",
        "mean",
        "stddev",
        "smac",
        "dmac",
        "sum",
        "min",
        "max",
        "soui",
        "doui",
        "sco",
        "dco",
        "spkts",
        "dpkts",
        "sbytes",
        "dbytes",
        "rate",
        "srate",
        "drate",
        "attack",
        "category",
        "subcategory",
      ],
      rows: [
        [
          "1",
          "14.55213",
          "e",
          "8",
          "arp",
          "cc:f8:9f:fe:8e:67",
          "0",
          "ff:ff:ff:ff:ff:ff",
          "0",
          "1",
          "60",
          "CON",
          "0",
          "0",
          "0",
          "0",
          "0",
          "cc:f8:9f:fe:8e:67",
          "ff:ff:ff:ff:ff:ff",
          "0",
          "0",
          "0",
          "TP-Link",
          "Broadcast",
          "127.0.0.1",
          "127.0.0.1",
          "1",
          "0",
          "60",
          "0",
          "0",
          "0",
          "0",
          "0",
          "Normal",
          "Normal",
        ],
        [
          "2",
          "15.83021",
          "e",
          "8",
          "arp",
          "5e:ff:56:a2:af:15",
          "0",
          "ff:ff:ff:ff:ff:ff",
          "0",
          "1",
          "42",
          "CON",
          "0",
          "0",
          "0",
          "0",
          "0",
          "5e:ff:56:a2:af:15",
          "ff:ff:ff:ff:ff:ff",
          "0",
          "0",
          "0",
          "Unknown",
          "Broadcast",
          "127.0.0.1",
          "127.0.0.1",
          "1",
          "0",
          "42",
          "0",
          "0",
          "0",
          "0",
          "0",
          "Normal",
          "Normal",
        ],
      ],
      totalRows: 3668045,
      totalColumns: 36,
    },
  };

  return (
    previews[datasetName] || {
      type: "unknown",
      message: "Preview not available for this dataset",
    }
  );
}
